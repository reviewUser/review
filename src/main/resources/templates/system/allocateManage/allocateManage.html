<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">
<head>
	<meta charset="utf-8" />
	<meta name="viewport"
		  content="width=device-width, initial-scale=1, maximum-scale=1" />
	<title>评审专家管理</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="../../static/layui/css/layui.css"
		  th:href="@{/layui/css/layui.css}" />
	<link rel="stylesheet" href="../../static/css/allocate.css"
		  th:href="@{/css/allocate.css}" />
	<style type="text/css">
#tableInfo{
	width:1500px;
	position:static;
	min-width:1000px;
}
</style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
	<div class="layui-header">
		<div class="layui-logo">长庆石油专家任务评审系统</div>
		<!-- 头部区域（可配合layui已有的水平导航） -->

		<ul class="layui-nav layui-layout-right">
			<li class="layui-nav-item"><a href="javascript:;"> <span th:text="${session.user.username}">贤心</span></a></li>
			<li class="layui-nav-item"><a href="" th:href="@{/user/logout}">注销</a></li>
		</ul>
	</div>

	<div class="layui-side layui-bg-black">
		<div class="layui-side-scroll">
			<!-- 左侧导航区域（可配合layui已有的垂直导航） -->
			<ul class="layui-nav layui-nav-tree">
				<!--					<li class="layui-nav-item layui-nav-itemed">-->
				<!--						<a class="" href="javascript:;" th:href="@{/group/groupManagePage}">评审任务分组管理</a>-->
				<!--					</li>-->
				<li class="layui-nav-item layui-nav-itemed"><a class=""
															   href="javascript:;" th:href="@{/project/allocateManagePage}"><STRONG>评审专家管理</STRONG></a></li>
				<li class="layui-nav-item layui-nav-itemed"><a href="javascript:;" th:href="@{/project/managePage}"><STRONG>评审任务管理</STRONG></a></li>
				<!--					<li class="layui-nav-item layui-nav-itemed"><a href="javascript:;">用户管理</a>-->
				<dl class="layui-nav-child">
					<dd>
						<a class="" href="javascript:;" th:href="@{/project/userPage?role=1}">评审任务管理</a>
					</dd>
					<dd>
						<a class="" href="javascript:;" th:href="@{/project/userPage?role=2}">评审专家管理</a>
					</dd>
					<!--							<dd>-->
					<!--								<a class="" href="javascript:;" th:href="@{/project/userPage?role=3}">管理员管理</a>-->
					<!--							</dd>-->
				</dl></li>
				<!--						<li class="layui-nav-item layui-nav-itemed"><a class=""-->
				<!--						href="javascript:;" th:href="@{/field/fieldPage}">领域标签管理</a></li>-->
			</ul>
		</div>
	</div>

	<div class="layui-body">
			<span class="layui-breadcrumb" lay-separator="/">
			  <a href=""><cite>专家信息</cite></a>
			</span>
		<blockquote class="layui-elem-quote"><BIG>系统内相关专家信息</BIG></blockquote>
		<form class="layui-form" id="select-form">
			<div class="layui-form-item">
				<table border="0" cellspacing="0" style="margin-right:20px">
					<tr>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">工号</label>
								<div class="layui-input-inline">
									<input id="id" type="text" name="ID"
										   placeholder="" autocomplete="off"
										   class="layui-input"/>
								</div>
							</div>
						</td>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">姓名</label>
								<div class="layui-input-inline">
									<input id="username" type="text" name="username"
										   placeholder="根据姓名模糊搜索" autocomplete="off"
										   class="layui-input"/>
								</div>
							</div>
						</td>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">职称</label>
								<div class="layui-input-inline">
									<select id="status" name="status">
										<option value=""></option>
										<option value="WAIT_REVIEW">科员</option>
										<option value="IN_REVIEW">副科</option>
										<option value="REVIEW_DONE">正科</option>
										<option value="IN_REVIEW">副处</option>
										<option value="REVIEW_DONE">正处</option>
									</select>
								</div>
							</div>
						</td>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">技术职级</label>
								<div class="layui-input-inline">
									<select id="level" name="status">
										<option value=""></option>
										<option value="WAIT_REVIEW">高级工程师</option>
										<option value="IN_REVIEW">中级工程师</option>
										<option value="REVIEW_DONE">初级工程师</option>
									</select>
								</div>
							</div>
						</td>
					</tr>
					<tr>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">擅长专业领域</label>
								<div class="layui-input-inline">
									<select id="profession" name="status">
										<option value=""></option>
										<option value="WAIT_REVIEW">财务</option>
										<option value="IN_REVIEW">工程</option>
										<option value="REVIEW_DONE">地质</option>
									</select>
								</div>
							</div>
						</td>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">手机号码</label>
								<div class="layui-input-inline">
									<input tnum="telephone" type="text" name="tnum"
										   placeholder="" autocomplete="off"
										   class="layui-input"/>
								</div>
							</div>
						</td>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">参与评审积分</label>
								<div class="layui-input-inline">
									<input tnum="innum" type="text" name="tnum"
										   placeholder="" autocomplete="off"
										   class="layui-input"/>
								</div>
							</div>
						</td>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">拒绝评审次数</label>
								<div class="layui-input-inline">
									<input tnum="refuse" type="text" name="tnum"
										   placeholder="" autocomplete="off"
										   class="layui-input"/>
								</div>
							</div>
						</td>
					</tr>
					<tr>
						<td>
							<div class="layui-inline">
								<label class="layui-form-label" style="width:150px">状态</label>
								<div class="layui-input-inline">
									<select id="state" name="status">
										<option value=""></option>
										<option value="WAIT_REVIEW">正常</option>
										<option value="IN_REVIEW">封禁</option>
									</select>
								</div>
							</div>
						</td>
					</tr>
				</table>
				<div class="layui-inline" style="align='center'">
					<label class="layui-form-label" style="margin-right: 600px"></label>
					<a id="select" class="layui-btn layui-btn-normal layui-btn-radius"><i style="padding-right: 4px;" class="layui-icon">&#xe615;</i>查询</a>
				</div>
			</div>
		</form>
		<div id="layerDemo" class="layui-btn-container" style="margin-top:100px">
			<label class="layui-form-label" style="width: 20px"></label>
			<button type="button" class="layui-btn layui-btn-normal" id="import"><i class="layui-icon"></i>批量导入</button>
			<button  data-method="offset" type="button" data-type="auto" class="layui-btn layui-btn-normal">手动添加</button>
			<button type="button" class="layui-btn layui-btn-normal" lay-submit lay-filter="delete">删除</button>
			<button type="button" class="layui-btn layui-btn-warm" id="export"><i class="layui-icon"></i>批量导出</button>
		</div>
		<div id="tableInfo">
			<label class="layui-form-label" style="width:20px"></label>
			<table class="layui-hide" id="groupinfo" lay-data="{id:'groupinfo'}" lay-filter="groupinfotable">
					</table>
			<script id="barDemo" type="text/html">
				<a class="layui-btn layui-btn-xs" lay-event="allocate"><i style="padding-right: 4px;" class="layui-icon">&#xe609;</i>选择专家</a>
			</script>
		</div>
	</div>
	<div class="layui-footer">
		<!-- 底部固定区域 -->
		<p style="text-align: center;">© All Rights Reserve By ChinaSoft</p>
	</div>
</div>
<script src="../../static/layui/layui.js" th:src="@{/layui/layui.js}"></script>

<script>
	/*<![CDATA[*/
		//JavaScript代码区域
		layui.use(['jquery','layer','form','table','laydate','element','upload'], function() {
			var $ = layui.jquery,
			layer = layui.layer,
			form = layui.form,
			table = layui.table,
			laydate = layui.laydate,
			element = layui.element,
			upload = layui.upload,
			dropdown=layui.dropdown,
			until=layui.until;

			var params = {};
			params.pageNum = 1;
			params.pageSize = 10;
			params.id=$('#id').val();
			params.workNumber =$('#work_number').val();
			params.name =$('#name').val();
			params.level =$('#expert_level').val();
			params.technologyLevel =$('#technology_level').val();
			params.fieldName =$('#field_name').val();
			params.phone =$('#phone').val();
			params.birthday =$('#birthday').val();
			params.age =$('#age').val();
			params.integral =$('#integral').val();
			params.refuseCount =$('#refuse_count').val();
			params.expertStatus =$('#expert_status').val();

			$.ajax({
      			  url: '/expert/queryExpertInfo',
				  method: 'post',
				  contentType:'application/json;charset=utf-8',
				  data:JSON.stringify(params),
				  success: function(res) {
				  	renderTable(res.data);
				  }
				})
			var colsnew=[ //表头
					  {type:'checkbox'}
					  ,{field: 'id', title: '序号', width:100, sort: true}
					  ,{field: 'workNumber', title: '工号', width:120, sort:true}
					  ,{field: 'name', title: '姓名', width:80}
					  ,{field: 'level', title: '职称', width: 120}
					  ,{field: 'technologyLevel', title: '技术职级', width: 100}
					  ,{field: 'fieldName', title: '擅长专业领域', width: 150}
					  ,{field: 'phone', title: '电话', width: 150}
					  ,{field: 'birthday', title: '出生日期', width:100}
					  ,{field: 'age', title: '年龄', width:80, sort:true}
					  ,{field: 'integral', title: '参与评审积分', width:130,sort:true}
					  ,{field: 'refuseCount', title:'拒绝评审次数', width: 130,sort:true}
					  ,{field: 'expertStatus', title: '专家状态', width:100}
					]
				var renderTable = function(data) {
				    var tableIns = table.render({
						elem: '#groupinfo'
						,id:'groupinfo'
						,width: '100%'
						,data:data
						,cols: [colsnew]
						,request: {
							pageName: 'pageNum', //页码的参数名称
							limitName: 'pageSize' //每页数据量的参数名
            		 }
            		,done: function (res, curr, count) {
                		this.cols = []; //（关键代码）将cols初始化，否则表格重载时无法正确重新渲染表头
            		}
				   ,page:{
               		 	limit: params.pageSize ,//指定每页显示的条数
                        limits: [5, 10, 15, 20, 25, 30, 35, 40, 45, 50], //每页数据量的参数名
            		 }
				  });
				  //重载
            		table.render().reload('groupinfo', { cols: [colsnew] })
            		 //查询
            		 $("#select").click(function Search(page) {
            		 	var search={};
						search.workNumber=$("#work_number").val();
						search.name=$("#name").val();
						search.level =$('#expert_level').val();
						search.technologyLevel =$('#technology_level').val();
						search.fieldName =$('#field_name').val();
						search.phone =$('#phone').val();
						search.birthday =$('#birthday').val();
						search.age =$('#age').val();
						search.integral =$('#integral').val();
						search.refuseCount =$('#refuse_count').val();
						search.expertStatus =$('#expert_status').val();
						$.ajax({
							url:"/expert/queryExpertInfo",
							method:"post",
							contentType:'application/json;charset=utf-8',
				  			data:JSON.stringify(params),
							success:function (data) {
									if(data){
										 tableIns.reload({
										   where: { //设定异步数据接口的额外参数，任意设
											    workNumber:$("#work_number").val(),
												name:$("#name").val(),
												level :$('#expert_level').val(),
												technologyLevel :$('#technology_level').val(),
												fieldName :$('#field_name').val(),
												phone :$('#phone').val(),
												integral :$('#integral').val(),
												refuseCount :$('#refuse_count').val(),
												expertStatus :$('#expert_status').val(),
										   }
										   ,page: {
											 curr: 1 //重新从第 1 页开始
										   }
										 });
									}else{
										alert("暂无此人")
									}
    							}
						})
					});
				}

				//监听工具条
			  table.on('tool(groupinfotable)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
			     var data = obj.data //获得当前行数据
			    ,layEvent = obj.event; //获得 lay-event 对应的值
			    if(layEvent === 'detail'){
			    	if (data.allocate != '选择完成'){
			    		layer.msg('目前发送状态为：'+ data.status + ",请耐心等待");
			    		window.location.href="/project/allocatePage?id="+id;
			    	} else {
			    		var projectId = data.id;
				    	window.location.href="/review/resultPage?id="+projectId;
			    	}
			    }
			  });

			//文件上传
			upload.render({
			  elem: '#import'
    		  ,url: '/expert/importExpertExcel' //此处配置你自己的上传接口即可
    		  ,accept: 'file' //普通文件
    		  ,done: function(res){
    		    layer.msg('上传成功');
    		    console.log(res);
    			}
    		 });
    		//弹窗
			var active = {
      		offset: function(othis){
      			var type = othis.data('type')
      			,text = othis.text();
      			layer.open({
        		type: 1
        		,title:'专家信息'
        		,area:'800px,600px'
        		,offset: 'auto'
        		,id: 'layerDemo'+type //防止重复弹出
        		,content: '<form style="height:300px"><table border="0" cellspacing="0" style="margin-right:30px" id="add_table"><tr><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">工号</label><div class="layui-input-inline"><input id="id" type="text" name="ID" autocomplete="off" class="layui-input"/></div></div></td><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">姓名</label><div class="layui-input-inline"><input id="username" type="text" name="username" autocomplete="off" class="layui-input"/></div></div></td><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">职称</label><div class="layui-input-inline"><input id="status" type="text" name="Status" autocomplete="off" class="layui-input"/></div></div></td></tr><tr><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">技术职级</label><div class="layui-input-inline"><input id="level" type="text" name="level" autocomplete="off" class="layui-input"/></div></div></td><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">擅长专业领域</label><div class="layui-input-inline"><input id="username" type="text" name="username" autocomplete="off" class="layui-input"/></div></div></td><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">手机号码</label><div class="layui-input-inline"><input tnum="telephone" type="text" name="tnum" autocomplete="off" class="layui-input"/></div></div></td></tr><tr><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">参与评审积分</label><div class="layui-input-inline"><input tnum="innum" type="text" name="tnum" autocomplete="off" class="layui-input"/></div></div></td><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">拒绝评审次数</label><div class="layui-input-inline"><input tnum="refuse" type="text" name="tnum" autocomplete="off" class="layui-input"/></div></div></td><td><div class="layui-inline"><label class="layui-form-label" style="width:150px">状态</label><div class="layui-input-inline"><input id="status" type="text" name="status" autocomplete="off"class="layui-input"/></div></div></td></tr></table></form>'
        		,btn: ['保存','取消']
        		,btnAlign: 'c'
        		,shade: 0 //不显示遮罩
        		,yes: function(){
          				$(that).click();
        			}
        			,btn2: function(){
        				layer.closeAll();
        			}
      		    });
    		}

			};
  			$('#layerDemo .layui-btn').on('click', function(){
  				var othis = $(this), method = othis.data('method');
  				active[method] ? active[method].call(this, othis) : '';
  				/*
            	var popupWindow = new Vue({
					elem: '#add_table',
					data: {
						type: '',
						sql: '',
					},
					updated: function () {
						layui.use('form', function () {
							layui.form.render('select');
						})
					},
					methods: {
						sql_submit() {
							if (!this.sql) {
								$.message({message: "sql语句不能为空！", type: 'warning'})
								return
							} else if (!this.type) {
								$.message({message: "类别不能为空！", type: 'warning'})
								return
							}
							//发送请求给后台
							fetch("url", {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({sqlType: this.type, sql: this.sql})
							})
								.then(res => res.json())
								.then(res => {  //res就是后台返回的结果
										console.log(res)
										if (res.data != null) {  //判断请求是否成功
											if (res.type === '查询') {
												$.message({message: "查询成功！", type: 'success'})
												setTimeout(() => {
													returnData(res)
												}, 1000)
											}
											if (res.type === '新增') {
												$.message({message: "新增成功！", type: 'success'})
												setTimeout(() => {
													exitWindow()
												}, 1000)
											}
											if (res.type === '修改') {
												$.message({message: "修改成功！", type: 'success'})
												setTimeout(() => {
													exitWindow()
												}, 1000)
											}
											if (res.type === '删除') {
												$.message({message: "删除成功！", type: 'success'})
												setTimeout(() => {
													exitWindow()
												}, 1000)
											}
										} else {
											$.message({message: "操作失败！", type: 'error'})
										}
									}
								)
						},
					}
				})
				*/
  			});
  			//删除
  			form.on('submit(delete)',function(data){
            	var checkStatus = table.checkStatus('id'); //idTest 即为基础参数 id 对应的值
            	console.log(checkStatus.data[0]) //获取选中行的数据
            	console.log(checkStatus.data.length) //获取选中行数量，可作为是否有选中行的条件
            	console.log(checkStatus.isAll ) //表格是否全选

            	$.ajax({
                	url:'/expert/delExpert',
                	method:'post',
                	data:{
                    	"id": checkStatus.data[0]
                	},
                	success:function(data){
                    	if(data.code==1){
                        	layer.msg("删除成功",function() {time:1000});
                        	parent.location.reload();
                    	}else{
                        	layer.msg("删除失败",function() {time:1000})
                    	}
                	}
            	})
        	})
        //导出
        layui.config({//配置并导入excel插件
    					base: '${base}/scripts/layui/layui_exts/'
    				}).use([ 'excel', 'layer'], function() {
    			var $ = layui.$;
    			var layer = layui.layer;
    			var excel = layui.excel;
    			$('#export').on('click', function(){
    					// 模拟从后端接口读取需要导出的数据
    					$.ajax({
    						url: '/expert/importExpertExcel'
    						,dataType: 'json'
    						,success(res) {
    							var data = res;
    							console.log(res);
    							// 重点！！！如果后端给的数据顺序和映射关系不对，请执行梳理函数后导出
    							data = excel.filterExportData(data, [
    								'id'
    								,'work_number'
    								,'name'
    								,'expert_level'
    								,'technology_level'
    								,'field_name'
    								,'phone'
    								,'birthday'
    								,'age'
    								,'integral'
    								,'refuse_count'
    								,'status'
    							]);
    							// 重点2！！！一般都需要加一个表头，表头的键名顺序需要与最终导出的数据一致
    							data.unshift({id:"序号",work_number:"工号",name:"姓名",expert_level:"职称",technology_level:"技术职级",field_name:"擅长专业领域",phone:"电话号码",birthday:"生日",age:"年龄",integral:"参与评审积分",refuse_count:"拒绝评审次数",status:"专家状态"});

    							excel.exportExcel(data, '专家信息表--'+'.xlsx', 'xlsx');
    						}
    						,error() {
    							layer.alert('获取数据失败，请检查是否部署在本地服务器环境下');
    						}
    					});
    				});
    			});
		});
		/* ]]> */
	</script>
</body>
</html>